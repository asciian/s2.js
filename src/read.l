(ir::include "src/libstd.l")

(defun tokenize (str)
  (let ((op (new (RegExp "(\"(?:\\\\\"|[^\"])*\"|,@|[,'`()]|\\s)"))))
    (defun sub (exp)
      (let ((br (new (RegExp "[^\\s]"))))
	(return-from sub (.test br exp))))
    (return-from tokenize
      (.filter (.split str op) sub))))

(defun readterm (tokens)
  (let ((result (list)) (cnt 1))
    (while (or (eql (.at tokens 0) "'")
	       (eql (.at tokens 0) "`")
	       (eql (.at tokens 0) ",")
	       (eql (.at tokens 0) ",@"))
      (.push result (.shift tokens)))
    (when (eql (.at tokens 0) "(")
      (.push result (.shift tokens))
      (while (< 0 cnt)
	(.push result (.shift tokens))
	(case (.at result (- (.length result) 1))
	  (("(") (++ cnt))
	  ((")") (-- cnt))))
      (return-from readterm result))
    (.push result (.shift tokens))
    (return-from readterm result)))

(defun parse (tokens)
  (when (eql 0 (.length tokens)) (return-from parse (list)))
  (let ((exp (readterm tokens)))
    (case (.at exp 0)
      (("'")  (return-from parse (.concat `((ir::quote     ,@(parse (.slice exp 1)))) (parse tokens))))
      (("`")  (return-from parse (.concat `((ir::backquote ,@(parse (.slice exp 1)))) (parse tokens))))
      ((",")  (return-from parse (.concat `((,@(list 'ir::unquote)   ,@(parse (.slice exp 1)))) (parse tokens))))
      ((",@") (return-from parse (.concat `((,@(list 'ir::splice)    ,@(parse (.slice exp 1)))) (parse tokens))))
      (("(")  (return-from parse (.concat (list (parse (.slice exp 1 -1))) (parse tokens))))
      (otherwise (return-from parse (.concat (list (.at exp 0)) (parse tokens)))))))

(defun read (str)
  (return-from read
    (parse (tokenize str)))
  (return-from read
    (.at (parse (tokenize str)) 0)))
